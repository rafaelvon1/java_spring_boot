name: ğŸ¤– Gemini Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ Instalar dependÃªncias Python
        run: |
          python3 -m pip install --upgrade pip
          pip install google-generativeai PyGithub

      - name: ğŸ¤– Rodar anÃ¡lise com Gemini 1.5 Flash
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF: ${{ github.ref }}
        run: |
          python3 <<'EOF'
          import os
          from github import Github
          import google.generativeai as genai

          # ğŸ”‘ ConfiguraÃ§Ãµes da API Gemini
          genai.configure(api_key=os.getenv("GEMINI_API_KEY"))
          model = genai.GenerativeModel("gemini-1.5-flash")

          # ğŸ§  Dados do PR
          repo_name = os.getenv("GITHUB_REPOSITORY")
          ref = os.getenv("GITHUB_REF")

          # Em PRs o ref vem no formato refs/pull/{num}/merge
          pr_number = int(ref.split("/")[2])
          g = Github(os.getenv("GITHUB_TOKEN"))
          repo = g.get_repo(repo_name)
          pr = repo.get_pull(pr_number)

          print(f"ğŸ” Analisando PR #{pr_number} de {repo_name}")

          # ğŸ“„ Monta diffs
          diffs = ""
          for f in pr.get_files():
              if f.patch:
                  diffs += f"### {f.filename}\n```diff\n{f.patch}\n```\n\n"

          # âœï¸ Gera prompt
          prompt = f"""
          FaÃ§a um code review tÃ©cnico e detalhado para este Pull Request.
          Identifique:
          - Problemas de lÃ³gica, performance ou seguranÃ§a
          - SugestÃµes de melhoria e boas prÃ¡ticas
          - Pontos de documentaÃ§Ã£o e clareza de cÃ³digo

          Analise cada trecho abaixo:

          {diffs}
          """

          # ğŸš€ Chamada ao Gemini
          response = model.generate_content(prompt)
          review_text = response.text or "âš ï¸ Nenhum feedback gerado."

          # ğŸ’¬ Posta comentÃ¡rio no PR
          pr.create_issue_comment(f"### ğŸ¤– Review automÃ¡tico Gemini\n\n{review_text}")

          print("âœ… Review postado com sucesso!")
          EOF
